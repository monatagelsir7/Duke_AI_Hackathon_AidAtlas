-- Organizations with verification fields
CREATE TABLE organizations (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(500) NOT NULL,
    ein VARCHAR(20) UNIQUE NOT NULL,
    
    -- Contact
    website TEXT,
    email VARCHAR(255),
    phone VARCHAR(50),
    address TEXT,
    city VARCHAR(100),
    state VARCHAR(50),
    zip VARCHAR(20),
    country VARCHAR(100) DEFAULT 'USA',
    
    -- Mission
    mission TEXT,
    description TEXT,
    causes TEXT[],
    
    -- Verification Status
    verification_status VARCHAR(50) DEFAULT 'pending',
    verification_level INTEGER DEFAULT 0, -- 0=unverified, 1-3=verified levels
    verification_data JSONB,
    last_verified TIMESTAMP,
    verified_by UUID REFERENCES admin_users(id),
    
    -- Third-party ratings
    charity_navigator_rating DECIMAL(2,1),
    charity_navigator_id VARCHAR(255),
    financial_rating DECIMAL(2,1),
    accountability_rating DECIMAL(2,1),
    
    guidestar_verified BOOLEAN DEFAULT false,
    guidestar_seal VARCHAR(50),
    
    bbb_accredited BOOLEAN DEFAULT false,
    
    -- Financial data
    total_revenue DECIMAL(15,2),
    total_expenses DECIMAL(15,2),
    program_expenses DECIMAL(15,2),
    administrative_expenses DECIMAL(15,2),
    fundraising_expenses DECIMAL(15,2),
    program_expense_percentage DECIMAL(5,2),
    overhead_percentage DECIMAL(5,2),
    fiscal_year_end DATE,
    
    -- Trust score
    trust_score INTEGER, -- 0-100
    trust_score_updated TIMESTAMP,
    
    -- Risk assessment
    risk_level VARCHAR(20), -- low, medium, high
    risk_score DECIMAL(3,2), -- 0.0-1.0
    risk_assessment JSONB,
    
    -- Operational
    years_operating INTEGER,
    consistent_990_filing BOOLEAN,
    last_impact_update TIMESTAMP,
    
    -- Stripe Connect
    stripe_account_id VARCHAR(255) UNIQUE,
    stripe_onboarding_completed BOOLEAN DEFAULT false,
    stripe_charges_enabled BOOLEAN DEFAULT false,
    stripe_payouts_enabled BOOLEAN DEFAULT false,
    
    -- Status
    is_active BOOLEAN DEFAULT true,
    is_featured BOOLEAN DEFAULT false,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Verification documents
CREATE TABLE verification_documents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
    
    document_type VARCHAR(100) NOT NULL, -- irs_determination_letter, form_990, etc.
    file_url TEXT NOT NULL,
    file_size INTEGER,
    mime_type VARCHAR(100),
    
    -- OCR results
    ocr_text TEXT,
    
    -- AI analysis
    analysis JSONB,
    verified BOOLEAN DEFAULT false,
    confidence DECIMAL(3,2), -- 0.0-1.0
    extracted_data JSONB,
    
    -- Review
    reviewed_by UUID REFERENCES admin_users(id),
    reviewed_at TIMESTAMP,
    review_notes TEXT,
    
    uploaded_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Trust scores history
CREATE TABLE organization_trust_scores (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
    
    total_score INTEGER NOT NULL, -- 0-100
    breakdown JSONB, -- Score breakdown by category
    
    calculated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Verification history (audit log)
CREATE TABLE verification_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
    
    action VARCHAR(100), -- submitted, verified, rejected, etc.
    previous_status VARCHAR(50),
    new_status VARCHAR(50),
    
    performed_by UUID REFERENCES admin_users(id),
    notes TEXT,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- User-reported issues
CREATE TABLE organization_reports (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
    user_id UUID REFERENCES users(id) ON DELETE SET NULL,
    
    report_type VARCHAR(100), -- fraud, misinformation, poor_service, etc.
    description TEXT,
    evidence_urls TEXT[],
    
    status VARCHAR(50) DEFAULT 'pending', -- pending, investigating, resolved, dismissed
    resolution TEXT,
    resolved_by UUID REFERENCES admin_users(id),
    resolved_at TIMESTAMP,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Donation feedback (for trust scoring)
CREATE TABLE donation_feedback (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    donation_id UUID REFERENCES donations(id) ON DELETE CASCADE,
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
    
    user_satisfied BOOLEAN,
    rating INTEGER CHECK (rating >= 1 AND rating <= 5),
    feedback_text TEXT,
    
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Indexes
CREATE INDEX idx_orgs_verification_status ON organizations(verification_status);
CREATE INDEX idx_orgs_verification_level ON organizations(verification_level);
CREATE INDEX idx_orgs_trust_score ON organizations(trust_score);
CREATE INDEX idx_orgs_ein ON organizations(ein);
CREATE INDEX idx_verification_docs_org ON verification_documents(organization_id);
CREATE INDEX idx_trust_scores_org ON organization_trust_scores(organization_id);
CREATE INDEX idx_verification_history_org ON verification_history(organization_id);
CREATE INDEX idx_org_reports_org ON organization_reports(organization_id);
CREATE INDEX idx_org_reports_status ON organization_reports(status);