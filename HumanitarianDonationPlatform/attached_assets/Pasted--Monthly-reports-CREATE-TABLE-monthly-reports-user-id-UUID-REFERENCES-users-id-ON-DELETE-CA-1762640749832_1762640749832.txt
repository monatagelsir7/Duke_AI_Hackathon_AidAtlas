-- Monthly reports
CREATE TABLE monthly_reports (
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    month VARCHAR(7) NOT NULL, -- YYYY-MM
    report_data JSONB NOT NULL,
    generated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (user_id, month)
);

-- User badges
CREATE TABLE user_badges (
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    badge_type VARCHAR(100) NOT NULL,
    badge_name VARCHAR(255),
    badge_icon VARCHAR(50),
    badge_description TEXT,
    earned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    
    PRIMARY KEY (user_id, badge_type)
);

-- User points
CREATE TABLE user_points (
    user_id UUID PRIMARY KEY REFERENCES users(id) ON DELETE CASCADE,
    total_points INTEGER DEFAULT 0,
    points_this_month INTEGER DEFAULT 0,
    level INTEGER DEFAULT 1,
    next_level_points INTEGER DEFAULT 100,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Points history
CREATE TABLE points_history (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    activity_type VARCHAR(50) NOT NULL,
    points_earned INTEGER NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Monthly challenges
CREATE TABLE monthly_challenges (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    month VARCHAR(7) NOT NULL, -- YYYY-MM
    name VARCHAR(255) NOT NULL,
    description TEXT,
    icon VARCHAR(50),
    goal INTEGER,
    reward TEXT,
    display_order INTEGER,
    is_active BOOLEAN DEFAULT true
);

-- User challenge progress
CREATE TABLE user_challenges (
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    challenge_id UUID REFERENCES monthly_challenges(id) ON DELETE CASCADE,
    progress INTEGER DEFAULT 0,
    completed BOOLEAN DEFAULT false,
    completed_at TIMESTAMP,
    
    PRIMARY KEY (user_id, challenge_id)
);

-- Impact stories (from organizations)
CREATE TABLE impact_stories (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    organization_id UUID REFERENCES organizations(id) ON DELETE CASCADE,
    conflict_id UUID REFERENCES conflicts(id) ON DELETE SET NULL,
    
    title VARCHAR(500),
    story_text TEXT NOT NULL,
    image_url TEXT,
    
    beneficiary_type VARCHAR(100), -- individual, family, community
    impact_metric VARCHAR(255), -- "100 families housed", "500 children fed"
    
    published_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    is_featured BOOLEAN DEFAULT false
);

-- Shareable reports (public URLs)
CREATE TABLE shareable_reports (
    share_id VARCHAR(32) PRIMARY KEY,
    user_id UUID REFERENCES users(id) ON DELETE CASCADE,
    month VARCHAR(7) NOT NULL,
    views INTEGER DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_monthly_reports_user ON monthly_reports(user_id);
CREATE INDEX idx_user_badges_user ON user_badges(user_id);
CREATE INDEX idx_points_history_user ON points_history(user_id);
CREATE INDEX idx_user_challenges ON user_challenges(user_id, challenge_id);
CREATE INDEX idx_impact_stories_org ON impact_stories(organization_id);
CREATE INDEX idx_shareable_reports_share ON shareable_reports(share_id);